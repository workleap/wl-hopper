name: Claude Code Review

on:
    pull_request:
        types: [opened, synchronize, ready_for_review, reopened]

jobs:
    claude-review:
        # Optional: Filter by PR author
        # if: |
        #   github.event.pull_request.user.login == 'external-contributor' ||
        #   github.event.pull_request.user.login == 'new-developer' ||
        #   github.event.pull_request.author_association == 'FIRST_TIME_CONTRIBUTOR'

        runs-on: workleap
        permissions:
            contents: read
            pull-requests: read
            issues: read
            id-token: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v5
              with:
                  fetch-depth: 1

            - name: Run Claude Code Review
              id: claude-review
              uses: anthropics/claude-code-action@v1
              with:
                  claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
                  plugin_marketplaces: "https://github.com/anthropics/claude-code.git"
                  plugins: "code-review@claude-code-plugins"
                  prompt: |
                      /code-review:code-review ${{ github.repository }}/pull/${{ github.event.pull_request.number }}
                      - Also run validate_hopper_code on any frontend code changes
                  claude_args: |
                      --allowedTools "
                        mcp__hopper__*,
                        mcp__hopper__get_guide,
                        mcp__hopper__get_component_doc,
                        mcp__hopper__validate_hopper_code,
                        mcp__hopper__get_design_tokens,
                        mcp__hopper__get_icons
                        "
                      --verbose
